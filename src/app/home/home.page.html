<ion-content class="fondo-personalizado">
  <div class="ion-padding">
    <ion-card class="panel-admin-glass">
      <ion-card-content>

        <!-- Encabezado con buscador -->
        <div class="cabecera-admin">
          <h2 class="titulo-admin">Administracion del sistema</h2>
          <div class="busqueda-usuarios ion-margin-bottom">
          <ion-searchbar
              placeholder="Buscar por nombre, apellido o cédula"
              [(ngModel)]="filtroBusqueda"
              (ionInput)="filtrarUsuarios()"
              showClearButton="always"
          ></ion-searchbar>
          </div>
        </div>

        <!-- Visualizador de fecha actual -->
        <div class="ion-text-end" style="margin-bottom: 10px;">
          <ion-label color="medium"><strong>Fecha actual:</strong> {{ fechaActual }}</ion-label>
        </div>

        <!-- Lista de selección de usuarios -->
        <div *ngIf="mostrarSeleccion" class="seleccion-usuarios ion-padding-bottom">
          <h4 class="ion-text-center">Selecciona un usuario:</h4>
          <ion-list lines="full">
            <ion-item button detail *ngFor="let u of usuariosEncontrados" (click)="obtenerResumenAsistencia(u.id)">
              <ion-avatar slot="start">
                <ion-icon name="person-circle-outline" style="font-size: 2.2em;"></ion-icon>
              </ion-avatar>
              <ion-label>
                <strong>{{ u.name }} {{ u.lastname }}</strong><br>
                <span style="font-size: 13px; color: #666;">Cédula: {{ u.identification }}</span>
                <span *ngIf="u.email" style="font-size: 12px; color: #888; display: block;">{{ u.email }}</span>
              </ion-label>
            </ion-item>
          </ion-list>
        </div>

        <!-- Mostrar mensaje si no hay usuario cargado -->
        <div *ngIf="!usuario && !buscando" class="ion-text-center ion-padding-top">
          <p>Ingrese una cédula o nombre para buscar un usuario</p>
        </div>

        <!-- Panel de información del usuario -->
      

        <div class="tarjetas-usuarios-grid">
          <ion-card *ngFor="let usuario of usuariosFiltrados" class="tarjeta-usuario">
            <ion-avatar class="avatar-usuario" style="background:#1976d2; display:flex; align-items:center; justify-content:center;">
              <span style="color:white; font-size:1.5em; font-weight:bold;">
                {{ (usuario.nombre || usuario.name)?.charAt(0) }}{{ (usuario.apellido || usuario.lastname)?.charAt(0) }}
              </span>
            </ion-avatar>
            <ion-card-header>
              <ion-card-title class="nombre-usuario-tarjeta">{{ usuario.nombre || usuario.name }} {{ usuario.apellido || usuario.lastname }}</ion-card-title>
              <ion-card-subtitle class="ion-text-center">Cédula: {{ usuario.cedula || usuario.identification }}</ion-card-subtitle>
            </ion-card-header>
            <ion-card-content>
              <div class="botones-tarjeta">
                <ion-button class="color-azul-personalizado" (click)="verAsistencia(usuario)">
                  <ion-icon name="document-text-outline" slot="start"></ion-icon>
                  <span style="font-size: 13px;">Ver asistencia</span>
                </ion-button>
                <ion-button class="color-naranja-personalizado" (click)="verHorarios(usuario)">
                  <ion-icon name="calendar-outline" slot="start"></ion-icon>
                  <span style="font-size: 13px;">Horarios</span>
                </ion-button>
              </div>
            </ion-card-content>
          </ion-card>
        </div>

        <!-- Filtros de mes y año -->
        <!-- (Eliminado: ahora los filtros están dentro del modal) -->

        <!-- Modal de asistencia -->
        <ion-modal *ngIf="mostrarModalAsistencia" [isOpen]="mostrarModalAsistencia" (didDismiss)="cerrarModalAsistencia()">
          <ng-template>
            <ion-header>
              <ion-toolbar color="primary">
                <ion-title>Resumen de Asistencia</ion-title>
                <ion-buttons slot="end">
                  <ion-button (click)="cerrarModalAsistencia()">Cerrar</ion-button>
                </ion-buttons>
              </ion-toolbar>
            </ion-header>
            <div class="ion-padding fondo-modal-asistencia" style="max-height:80vh; overflow-y:auto; margin-bottom: 24px;">
              <div class="modal-asistencia-header">
                <h2 class="nombre-usuario-modal">
                  {{ usuarioSeleccionado?.nombre || usuarioSeleccionado?.name }} {{ usuarioSeleccionado?.apellido || usuarioSeleccionado?.lastname }}
                </h2>
                <div class="fecha-actual-modal">
                  <strong>Fecha actual:</strong> {{ fechaActual }}
                </div>
                <div class="horario-hoy-modal" style="margin-top:8px;">
                  <ng-container *ngIf="resumenAsistencia?.registro_hoy && resumenAsistencia.registro_hoy.length > 0; else sinHorarioHoy">
                    <ion-badge color="primary" style="font-size:15px;">
                      Horario asignado hoy:
                      <ng-container *ngFor="let registro of resumenAsistencia.registro_hoy; let last = last">
                        <span *ngIf="registro.horario !== '-'">{{ registro.horario }}<span *ngIf="!last">, </span></span>
                      </ng-container>
                    </ion-badge>
                  </ng-container>
                  <ng-template #sinHorarioHoy>
                    <ion-badge color="warning" style="font-size:15px;">No hay horario asignado para hoy</ion-badge>
                  </ng-template>
                </div>
              </div>
              <!-- Filtros de mes y año dentro del modal -->
              <div class="filtros-mes-anio" style="display:flex; gap:10px; align-items:center; margin:10px 0;">
                <ion-label>Mes:</ion-label>
                <ion-select [(ngModel)]="mesSeleccionado" (ionChange)="onFiltroMesAnioModalChange()">
                  <ion-select-option *ngFor="let m of [1,2,3,4,5,6,7,8,9,10,11,12]" [value]="m">
                    {{ ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'][m-1] }}
                  </ion-select-option>
                </ion-select>
                <ion-label>Año:</ion-label>
                <ion-select [(ngModel)]="anioSeleccionado" (ionChange)="onFiltroMesAnioModalChange()">
                  <ion-select-option *ngFor="let y of [2023,2024,2025,2026]" [value]="y">{{ y }}</ion-select-option>
                </ion-select>
              </div>
              <div class="cuadros-resumen-modal">
                <div class="cuadro-azul">
                  <ion-icon name="calendar-number-outline" class="icono-cuadro"></ion-icon>
                  Días laborados en {{ ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'][mesResumen-1] }}: <strong>{{ resumenAsistencia.dias_laborados }}</strong>
                </div>
                <div class="cuadro-verde">
                  <ion-icon name="close-circle-outline" class="icono-cuadro"></ion-icon>
                  Faltas sin justificación: <strong>{{ resumenAsistencia.faltas_sin_justificacion }}</strong>
                </div>
                <div class="cuadro-rojo">
                  <ion-icon name="alarm-outline" class="icono-cuadro"></ion-icon>
                  Atrasos: <strong>{{ resumenAsistencia.atrasos }}</strong>
                </div>
              </div>
              <div class="panel-marcacion-modal">
                <ion-grid class="ion-margin-top">
                  <ion-row class="ion-text-center">
                    <ion-col><strong>Horario</strong></ion-col>
                    <ion-col><strong>Estado Entrada</strong></ion-col>
                    <ion-col><strong>Hora Entrada</strong></ion-col>
                    <ion-col><strong>Motivo Entrada</strong></ion-col>
                    <ion-col><strong>Estado Salida</strong></ion-col>
                    <ion-col><strong>Hora Salida</strong></ion-col>
                    <ion-col><strong>Motivo Salida</strong></ion-col>
                    <ion-col><strong>Mapa Entrada</strong></ion-col>
                    <ion-col><strong>Mapa Salida</strong></ion-col>
                  </ion-row>
                  <ng-container *ngFor="let registro of resumenAsistencia.registro_hoy">
                  <ion-row class="ion-text-center">
                      <ion-col>
                        <span *ngIf="registro.horario !== '-'">{{ registro.horario }}</span>
                        <span *ngIf="registro.horario === '-'">Sin horario asignado</span>
                      </ion-col>
                      <ion-col [ngClass]="{'falta-injustificada': registro.estado_entrada === 'Sin marcación' && registro.motivo_entrada === 'Falta injustificada'}">{{ registro.estado_entrada || '-' }}</ion-col>
                      <ion-col>{{ registro.hora_entrada || '-' }}</ion-col>
                      <ion-col>{{ registro.motivo_entrada || '-' }}</ion-col>
                      <ion-col [ngClass]="{'falta-injustificada': registro.estado_salida === 'Sin marcación' && registro.motivo_salida === 'Falta injustificada'}">{{ registro.estado_salida || '-' }}</ion-col>
                      <ion-col>{{ registro.hora_salida || '-' }}</ion-col>
                      <ion-col>{{ registro.motivo_salida || '-' }}</ion-col>
                    <ion-col>
                        <ion-button fill="clear" size="small" *ngIf="registro.lat_entrada && registro.lng_entrada" (click)="abrirMapa({lat: registro.lat_entrada, lng: registro.lng_entrada})">
                        <ion-icon name="location-outline" size="large"></ion-icon>
                      </ion-button>
                        <ion-icon *ngIf="!(registro.lat_entrada && registro.lng_entrada)" name="location-outline" size="large" color="medium"></ion-icon>
                    </ion-col>
                    <ion-col>
                        <ion-button fill="clear" size="small" *ngIf="registro.lat_salida && registro.lng_salida" (click)="abrirMapa({lat: registro.lat_salida, lng: registro.lng_salida})">
                        <ion-icon name="location-outline" size="large"></ion-icon>
                      </ion-button>
                        <ion-icon *ngIf="!(registro.lat_salida && registro.lng_salida)" name="location-outline" size="large" color="medium"></ion-icon>
              </ion-col>
            </ion-row>
                  </ng-container>
          </ion-grid>
              </div>
              <ion-button expand="block" color="medium" (click)="verHistorial()">
                {{ mostrarHistorial ? 'OCULTAR HISTORIAL' : 'VER HISTORIAL DE REGISTRO' }}
              </ion-button>
              <div *ngIf="mostrarHistorial" class="contenedor-historial-home ion-margin-top" style="max-height:350px;overflow-y:auto;">
                <ng-container *ngIf="historialRegistros && historialRegistros.length > 0; else sinHorarios">
                  <ion-list>
                    <ion-item *ngFor="let registro of historialRegistros">
                      <ion-label>
                        <strong>{{ registro.fecha }} - {{ registro.horario }}</strong><br>
                        <ion-grid>
                          <ion-row class="ion-text-center">
                            <ion-col><strong>Estado Entrada</strong></ion-col>
                            <ion-col><strong>Hora Entrada</strong></ion-col>
                            <ion-col><strong>Motivo Entrada</strong></ion-col>
                            <ion-col><strong>Estado Salida</strong></ion-col>
                            <ion-col><strong>Hora Salida</strong></ion-col>
                            <ion-col><strong>Motivo Salida</strong></ion-col>
                            <ion-col><strong>Mapa Entrada</strong></ion-col>
                            <ion-col><strong>Mapa Salida</strong></ion-col>
                          </ion-row>
                          <ion-row class="ion-text-center">
                            <ion-col [ngClass]="{'falta-injustificada': registro.estado_entrada === 'Sin marcación' && registro.motivo_entrada === 'Falta injustificada'}">{{ registro.estado_entrada || '-' }}</ion-col>
                            <ion-col>{{ registro.hora_entrada || '-' }}</ion-col>
                            <ion-col>{{ registro.motivo_entrada || '-' }}</ion-col>
                            <ion-col [ngClass]="{'falta-injustificada': registro.estado_salida === 'Sin marcación' && registro.motivo_salida === 'Falta injustificada'}">{{ registro.estado_salida || '-' }}</ion-col>
                            <ion-col>{{ registro.hora_salida || '-' }}</ion-col>
                            <ion-col>{{ registro.motivo_salida || '-' }}</ion-col>
                            <ion-col>
                              <ion-button fill="clear" size="small" *ngIf="registro.lat_entrada && registro.lng_entrada" (click)="abrirMapa({lat: registro.lat_entrada, lng: registro.lng_entrada})">
                                  <ion-icon name="location-outline" size="large"></ion-icon>
                                </ion-button>
                              <ion-icon *ngIf="!(registro.lat_entrada && registro.lng_entrada)" name="location-outline" size="large" color="medium"></ion-icon>
                            </ion-col>
                            <ion-col>
                              <ion-button fill="clear" size="small" *ngIf="registro.lat_salida && registro.lng_salida" (click)="abrirMapa({lat: registro.lat_salida, lng: registro.lng_salida})">
                                  <ion-icon name="location-outline" size="large"></ion-icon>
                                </ion-button>
                              <ion-icon *ngIf="!(registro.lat_salida && registro.lng_salida)" name="location-outline" size="large" color="medium"></ion-icon>
                            </ion-col>
                          </ion-row>
                        </ion-grid>
                      </ion-label>
                    </ion-item>
                  </ion-list>
                </ng-container>
                <ng-template #sinHorarios>
                  <div class="ion-text-center ion-padding mensaje-vacio" style="color:#d32f2f; font-weight:bold;">No tiene asignaciones de horario para este mes.</div>
                </ng-template>
              </div>
            </div>
          </ng-template>
        </ion-modal>

        <!-- Modal de horarios -->
        <ion-modal *ngIf="mostrarModalHorarios" [isOpen]="mostrarModalHorarios" (didDismiss)="cerrarModalHorarios()">
          <ng-template>
            <ion-header>
              <ion-toolbar color="secondary">
                <ion-title>Horarios de {{ usuarioSeleccionado?.nombre || usuarioSeleccionado?.name }}</ion-title>
                <ion-buttons slot="end">
                  <ion-button (click)="cerrarModalHorarios()">Cerrar</ion-button>
                </ion-buttons>
              </ion-toolbar>
            </ion-header>
            <ion-content class="ion-padding">
              <ion-list *ngIf="horariosUsuario.length > 0">
                <ion-item *ngFor="let horario of horariosUsuario">
                  <ion-label>
                    <strong>{{ horario.nombreTurno || 'Horario' }}</strong><br>
                    <span *ngIf="horario.fechaInicio || horario.fechaFinRepeticion" style="color:#666; font-size:13px;">
                      Asignación: {{ horario.fechaInicio || '-' }} al {{ horario.fechaFinRepeticion || '-' }}<br>
                    </span>
                    {{ horario.horaInicio }} - {{ horario.horaFin }}<br>
                    Día(s): {{ getDiasTexto(horario.dias) }}<br>
                    Ubicación: {{ horario.ubicacionNombre || '-' }}
                  </ion-label>
                  <ion-button color="primary" (click)="editarHorario(horario)">Editar horario</ion-button>
                  <ion-button color="danger" (click)="confirmarEliminarHorario(horario)">Eliminar</ion-button>
                </ion-item>
              </ion-list>
              <div *ngIf="horariosUsuario.length === 0" class="ion-text-center ion-padding" style="color:#d32f2f; font-weight:bold;">
                <ion-icon name="alert-circle-outline" style="font-size:2em;"></ion-icon>
                <p>Este usuario no tiene horarios asignados.</p>
        </div>
            </ion-content>
          </ng-template>
        </ion-modal>

        <ion-alert
          [isOpen]="alertaEliminarHorarioAbierta"
          header="¿Eliminar horario?"
          message="¿Estás seguro de que deseas eliminar este horario? Esta acción no se puede deshacer."
          [buttons]="botonesAlertaEliminarHorario"
          (didDismiss)="alertaEliminarHorarioAbierta = false">
        </ion-alert>

        <ion-alert
          [isOpen]="alertaSinHorarioAbierta"
          header="Información"
          [message]="mensajeAlertaSinHorario"
          [buttons]="botonesAlertaSinHorario"
          (didDismiss)="alertaSinHorarioAbierta = false">
        </ion-alert>
      </ion-card-content>
    </ion-card>
  </div>
</ion-content>

<!-- Estilos para resaltar faltas -->
<style>
.falta-injustificada {
  color: #d32f2f;
  font-weight: bold;
}
</style>
