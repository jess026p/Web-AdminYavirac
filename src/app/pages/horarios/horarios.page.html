<ion-header>
  <ion-toolbar color="primary">
    <ion-title>Asignar Horario y Ubicación</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <ion-card>
    <ion-card-header>
      <ion-card-title>Asignar Horario y Ubicación</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <!-- Paso 1: Selección de usuario -->
      <div *ngIf="paso === 1">
        <div style="display: flex; justify-content: flex-end; align-items: center; gap: 8px; margin-bottom: 8px;">
          <ion-input placeholder="Buscar usuario..." [(ngModel)]="filtroUsuario" style="max-width: 200px;"></ion-input>
          <ion-button size="small" color="primary" (click)="siguientePaso()" [disabled]="!usuarioSeleccionado">
            Siguiente
          </ion-button>
        </div>
        <div style="max-height: 350px; overflow-y: auto;">
          <ion-list>
            <ion-radio-group [(ngModel)]="usuarioSeleccionado">
              <ion-item *ngFor="let usuario of usuarios | userFilter:filtroUsuario">
                <ion-label>
                  {{ usuario.name }} {{ usuario.lastname }} ({{ usuario.email }})
                  <span *ngIf="usuario.sinHorario" style="color: #888; font-weight: bold;"> (Sin asignación de horario)</span>
                </ion-label>
                <ion-radio slot="end" [value]="usuario.id"></ion-radio>
              </ion-item>
            </ion-radio-group>
          </ion-list>
        </div>
      </div>

      <!-- Paso 2: Configuración de horario -->
      <div *ngIf="paso === 2">
        <div *ngIf="ubicacionSeleccionada || ubicacionNombre" class="ion-text-center" style="color:#1976d2; font-weight:bold; margin-bottom:10px;">
          Estás editando un horario asignado
        </div>
        <ion-item color="light">
          <ion-label>
            <strong>Asignando horario a:</strong>
            <span *ngIf="usuarioSeleccionadoObj">
              {{ usuarioSeleccionadoObj.name }} {{ usuarioSeleccionadoObj.lastname }} ({{ usuarioSeleccionadoObj.email }})
            </span>
          </ion-label>
        </ion-item>
        <ion-item>
          <ion-label position="stacked">Nombre del turno (opcional)</ion-label>
          <ion-input [(ngModel)]="nombreTurno" name="nombreTurno" placeholder="Ej: Turno mañana" (ngModelChange)="onCampoEditado()"></ion-input>
        </ion-item>
        <ion-row>
          <ion-col size="6">
            <ion-item>
              <ion-label position="stacked">Inicio de turno</ion-label>
              <ion-input type="date" [(ngModel)]="fechaInicio" name="fechaInicio" placeholder="Selecciona la fecha" required (ngModelChange)="onCampoEditado()"></ion-input>
            </ion-item>
          </ion-col>
          <ion-col size="6">
            <ion-item>
              <ion-label position="stacked">Fin de repetición</ion-label>
              <ion-input type="date" [(ngModel)]="fechaFinRepeticion" name="fechaFinRepeticion" placeholder="Selecciona la fecha" required (ngModelChange)="onCampoEditado(); validarFechaFinRepeticion()"></ion-input>
            </ion-item>
          </ion-col>
        </ion-row>
        <ion-label class="ion-margin-bottom">Selecciona los días en que se repite el turno</ion-label>
        <ion-row>
          <ion-col size="auto" *ngFor="let dia of diasSemana">
            <ion-chip [color]="diasSeleccionados.includes(dia.value) ? 'primary' : 'medium'" (click)="toggleDia(dia.value)">
              <ion-label>{{ dia.label }}</ion-label>
            </ion-chip>
          </ion-col>
        </ion-row>
        <ion-row>
          <ion-col size="6">
            <ion-item>
              <ion-label position="stacked">Hora de inicio</ion-label>
              <ion-input
                type="time"
                [(ngModel)]="horaInicio"
                name="horaInicio"
                placeholder="Selecciona la hora"
                (ngModelChange)="onCampoEditado()">
              </ion-input>
            </ion-item>
          </ion-col>
          <ion-col size="6">
            <ion-item>
              <ion-label position="stacked">Hora de fin</ion-label>
              <ion-input type="time" #horaFinInput [(ngModel)]="horaFin" name="horaFin" placeholder="Selecciona la hora" (ngModelChange)="onCampoEditado(); onHoraFinChange()"></ion-input>
            </ion-item>
          </ion-col>
        </ion-row>
        <ion-row>
          <ion-col size="6">
            <ion-item>
              <ion-label position="stacked">Tolerancia de inicio (minutos)</ion-label>
              <ion-input type="number" [(ngModel)]="toleranciaInicio" name="toleranciaInicio" min="0" placeholder="5" (ngModelChange)="onCampoEditado()"></ion-input>
            </ion-item>
            <ion-note color="medium" style="padding-left: 16px;">
              {{toleranciaInicio}} min antes y después de entrada
            </ion-note>
          </ion-col>
          <ion-col size="6">
            <ion-item>
              <ion-label position="stacked">Atraso permitido (minutos)</ion-label>
              <ion-input type="number" [(ngModel)]="atrasoPermitido" name="atrasoPermitido" min="0" placeholder="10" (ngModelChange)="onCampoEditado()"></ion-input>
            </ion-item>
            <ion-note color="medium" style="padding-left: 16px;">
              Hasta {{atrasoPermitido}} min de atraso
            </ion-note>
          </ion-col>
        </ion-row>
        <ion-row class="ion-justify-content-between ion-margin-top">
          <ion-col size="auto">
            <ion-button color="medium" (click)="anteriorPaso()">Anterior</ion-button>
          </ion-col>
          <ion-col size="auto">
            <ion-button color="danger" (click)="cancelarFlujo()">Cancelar</ion-button>
          </ion-col>
          <ion-col size="auto">
            <ion-button 
              [color]="cambiosSinGuardar ? 'warning' : 'success'" 
              (click)="guardarHorario()" 
              [disabled]="!horaInicio || !horaFin || (repetirTurno && diasSeleccionados.length === 0)">
              Guardar horario
            </ion-button>
          </ion-col>
          <ion-col size="auto">
            <ion-button color="primary" (click)="siguientePaso()" [disabled]="horariosAgregados.length === 0">Siguiente</ion-button>
          </ion-col>
        </ion-row>
        <div *ngIf="cambiosSinGuardar" style="color: #d35400; font-weight: bold; margin-top: 8px;">Tienes cambios sin guardar</div>
        <ion-list *ngIf="horariosAgregados.length > 0">
          <ion-card *ngFor="let horario of horariosAgregados; let i = index" class="jornada-card">
            <ion-card-content>
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <h3 style="margin-bottom: 4px;">{{ horario.nombreTurno ? horario.nombreTurno : 'Jornada ' + (i + 1) }}</h3>
                  <p style="margin: 0; color: #666;">Asignación: {{ horario.fechaInicio || '-' }} al {{ horario.fechaFinRepeticion || '-' }}</p>
                  <p style="margin: 0; color: #666;">Días: {{ obtenerNombresDias(horario.dias) }}</p>
                  <p style="margin: 0; color: #666;">Horario: {{ horario.horaInicio }} - {{ horario.horaFin }}</p>
                  <p *ngIf="horario.horaAlmuerzoSalida && horario.horaAlmuerzoRegreso" style="margin: 0; color: #666;">
                    Almuerzo: {{ horario.horaAlmuerzoSalida }} - {{ horario.horaAlmuerzoRegreso }}
                  </p>
                  <p *ngIf="horario.toleranciaAtraso" style="margin: 0; color: #666;">
                    Tolerancia: {{ horario.toleranciaAtraso }} min
                  </p>
                  <p *ngIf="horario.ubicacionNombre" style="margin: 0; color: #666;">
                    Ubicación: {{ horario.ubicacionNombre }}
                  </p>
                </div>
                <div style="display: flex; flex-direction: column; gap: 4px; align-items: flex-end;">
                  <ion-button fill="clear" color="primary" (click)="editarHorarioAgregado(i)">
                    <ion-icon name="create-outline"></ion-icon>
                    Editar
                  </ion-button>
                  <ion-button color="danger" (click)="eliminarHorarioAgregado(i)">Eliminar</ion-button>
                </div>
              </div>
            </ion-card-content>
          </ion-card>
        </ion-list>
      </div>

      <!-- Paso 3: Asignación de ubicación por horario -->
      <div *ngIf="paso === 3">
        <ion-item color="light">
          <ion-label>
            <strong>Asignando ubicación a:</strong>
            <span *ngIf="usuarioSeleccionadoObj">
              {{ usuarioSeleccionadoObj.name }} {{ usuarioSeleccionadoObj.lastname }} ({{ usuarioSeleccionadoObj.email }})
            </span>
          </ion-label>
        </ion-item>
        <!-- Mostrar ubicación actual y botón de editar solo si se está editando un horario real -->
        <div *ngIf="horariosAgregados.length > 0 && horariosAgregados[0].id">
          <ion-card color="light" style="margin-bottom: 16px;">
            <ion-card-content>
              <div *ngIf="horariosAgregados[0].ubicacionNombre">
                <strong>Ubicación actual:</strong> {{ horariosAgregados[0].ubicacionNombre }}<br>
                <span *ngIf="horariosAgregados[0].ubicacionSeleccionada">
                  Lat: {{ horariosAgregados[0].ubicacionSeleccionada.lat }}, Lng: {{ horariosAgregados[0].ubicacionSeleccionada.lng }}
                </span>
              </div>
              <ion-button color="primary" (click)="abrirSelectorUbicacion(0)">
                Editar ubicación
              </ion-button>
            </ion-card-content>
          </ion-card>
        </div>
        <!-- Si no está editando un horario real, mostrar el flujo normal -->
        <ion-item lines="none">
          <ion-checkbox slot="start" [(ngModel)]="mismaUbicacionParaTodos" (ionChange)="onMismaUbicacionChange()"></ion-checkbox>
          <ion-label>Usar la misma ubicación para todos los horarios</ion-label>
        </ion-item>
        <ion-list>
          <ion-item *ngFor="let horario of horariosAgregados; let i = index">
            <ion-label>
              <h3>{{ horario.nombreTurno ? horario.nombreTurno : 'Horario ' + (i + 1) }}</h3>
              <p style="margin: 0; color: #666;">Asignación: {{ horario.fechaInicio || '-' }} al {{ horario.fechaFinRepeticion || '-' }}</p>
              <p>Días: {{ obtenerNombresDias(horario.dias) }}</p>
              <p>Horario: {{ horario.horaInicio }} - {{ horario.horaFin }}</p>
              <p *ngIf="horario.horaAlmuerzoSalida && horario.horaAlmuerzoRegreso">
                Almuerzo: {{ horario.horaAlmuerzoSalida }} - {{ horario.horaAlmuerzoRegreso }}
              </p>
              <p *ngIf="horario.toleranciaAtraso" style="margin: 0; color: #666;">
                Tolerancia: {{ horario.toleranciaAtraso }} min
              </p>
            </ion-label>
            <ion-button fill="clear" color="primary" (click)="abrirSelectorUbicacion(i)" *ngIf="!horario.id">
              <ion-icon name="location-outline"></ion-icon>
              Seleccionar ubicación
            </ion-button>
            <span *ngIf="horario.ubicacionNombre">{{ horario.ubicacionNombre }}</span>
          </ion-item>
        </ion-list>
        <!-- Modal o sección de mapa para seleccionar ubicación -->
        <div *ngIf="mostrarMapaUbicacion" class="ubicacion-modal">
          <ion-row>
            <ion-col size="8">
              <ion-item>
                <ion-label position="stacked">Buscar dirección</ion-label>
                <ion-input [(ngModel)]="busquedaDireccion" name="busquedaDireccion" placeholder="Ej: Av. Amazonas y Colón" (keyup.enter)="buscarDireccion()"></ion-input>
              </ion-item>
            </ion-col>
            <ion-col size="4">
              <ion-item>
                <ion-label position="stacked">Radio (metros)</ion-label>
                <ion-input type="number" [(ngModel)]="radioUbicacion" name="radioUbicacion" min="10" max="1000" step="10" placeholder="100"></ion-input>
              </ion-item>
            </ion-col>
          </ion-row>
          <div id="map" style="height: 400px; width: 100%; margin: 0 0 16px 0; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);"></div>
          <ion-item>
            <ion-label position="stacked">Nombre de la ubicación</ion-label>
            <ion-input [(ngModel)]="ubicacionNombre" name="ubicacionNombre" placeholder="Ej: Aula 6, Oficina Central"></ion-input>
          </ion-item>
          <ion-row class="ion-justify-content-end ion-margin-top">
            <ion-col size="auto">
              <ion-button color="success" (click)="asignarUbicacionSeleccionada()" [disabled]="!ubicacionNombre || !ubicacionSeleccionada">Asignar ubicación</ion-button>
            </ion-col>
            <ion-col size="auto">
              <ion-button color="medium" (click)="cerrarSelectorUbicacion()">Cancelar</ion-button>
            </ion-col>
          </ion-row>
        </div>
        <ion-row class="ion-justify-content-between ion-margin-top">
          <ion-col size="auto">
            <ion-button color="medium" (click)="anteriorPaso()">Anterior</ion-button>
          </ion-col>
          <ion-col size="auto">
            <ion-button color="danger" (click)="cancelarFlujo()">Cancelar</ion-button>
          </ion-col>
          <ion-col size="auto">
            <ion-button color="success" (click)="guardarAsignacion()" [disabled]="!todasUbicacionesAsignadas()">Guardar</ion-button>
          </ion-col>
        </ion-row>
      </div>
    </ion-card-content>
  </ion-card>

  <!-- Lista de asignaciones realizadas -->
  <ion-card *ngIf="asignaciones.length > 0">
    <ion-card-header>
      <ion-card-title>Asignaciones realizadas</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <ion-list>
        <ion-item *ngFor="let item of asignaciones; let i = index">
          <ion-label>
            <h3>Empleado: {{ item.empleadoNombre }}</h3>
            <p>Jornada: {{ obtenerNombreJornada(item.jornadaSeleccionada) }}</p>
            <p>Días: {{ item.diasSeleccionados.join(', ') }}</p>
            <p>Horario: {{ item.horaInicio }} - {{ item.horaFin }}</p>
            <p>Ubicación: {{ item.ubicacionNombre }}</p>
          </ion-label>
          <ion-button color="danger" (click)="eliminarAsignacion(i)">Eliminar</ion-button>
        </ion-item>
      </ion-list>
    </ion-card-content>
  </ion-card>
</ion-content> 